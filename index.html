<!DOCTYPE html>
<html lang="es">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Sistema POS - Embarcaciones Guatap√©</title>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <link rel="stylesheet" href="main.css">
</head>
<body>
   <!-- PANTALLA DE LOGIN -->
   <div id="loginScreen" class="login-screen">
       <div class="login-container">
           <div class="login-header">
               <i class="fas fa-anchor"></i>
               <h1>Embarcaciones Guatap√©</h1>
               <p>Sistema POS - Acceso Autorizado</p>
           </div>
           
           <form id="loginForm" class="login-form">
               <div class="form-group">
                   <label for="email">Correo Electr√≥nico</label>
                   <input type="email" id="email" required>
               </div>
               
               <div class="form-group">
                   <label for="password">Contrase√±a</label>
                   <div class="password-input">
                       <input type="password" id="password" required>
                       <button type="button" id="togglePassword" onclick="togglePassword()">üëÅÔ∏è</button>
                   </div>
               </div>
               
               <div id="errorMessage" class="error-message"></div>
               
               <button type="submit" id="loginBtn" class="login-btn">
                   <span id="loadingSpinner" class="loading-spinner"></span>
                   <span id="btnText">Iniciar Sesi√≥n</span>
               </button>
           </form>
           
           <div class="login-footer">
               <p>Solo personal autorizado</p>
           </div>
       </div>
   </div>

   <!-- SISTEMA PRINCIPAL -->
   <div id="mainSystem" class="main-system">
       <div class="main-container">
           <!-- PANEL POS -->
           <div class="pos-panel">
               <!-- INFORMACI√ìN DEL PASAJERO -->
               <div class="section">
                   <h2 class="section-title"><i class="fas fa-user"></i> Informaci√≥n del Pasajero</h2>
                   <div class="passenger-info-grid">
                       <div class="form-group">
                           <label class="form-label">Nombre Completo</label>
                           <input type="text" class="form-input" id="nombre" placeholder="Juan P√©rez Garc√≠a">
                       </div>
                       <div class="form-group">
                           <label class="form-label">Documento</label>
                           <input type="text" class="form-input" id="documento" placeholder="12345678">
                       </div>
                       <div class="form-group">
                           <label class="form-label">Email</label>
                           <input type="email" class="form-input" id="emailCliente" placeholder="ejemplo@email.com">
                       </div>
                       <div class="form-group">
                           <label class="form-label">Tel√©fono</label>
                           <input type="tel" class="form-input" id="telefono" placeholder="+57 300 123 4567">
                       </div>
                   </div>
               </div>

               <!-- DETALLES DEL VIAJE -->
               <div class="section">
                   <h2 class="section-title"><i class="fas fa-calendar-alt"></i> Detalles del Viaje</h2>
                   <div class="form-grid">
                       <div class="form-group">
                           <label class="form-label">Fecha de Viaje</label>
                           <input type="date" class="form-input" id="fecha">
                       </div>
                       <div class="form-group1">
                           <label class="form-label"><i class="fas fa-users"></i> Adultos</label>
                           <div class="counter-group">
                               <button class="counter-btn" onclick="decrementCounter('adultos')"><i class="fas fa-minus"></i></button>
                               <input type="number" class="counter-input" id="adultos" value="1" min="1" max="100">
                               <button class="counter-btn" onclick="incrementCounter('adultos')"><i class="fas fa-plus"></i></button>
                           </div>
                       </div>
                       <div class="form-group1">
                           <label class="form-label">Ni√±os (0-5 a√±os)</label>
                           <div class="counter-group">
                               <button class="counter-btn" onclick="decrementCounter('ninos')"><i class="fas fa-minus"></i></button>
                               <input type="number" class="counter-input" id="ninos" value="0" min="0" max="10">
                               <button class="counter-btn" onclick="incrementCounter('ninos')"><i class="fas fa-plus"></i></button>
                           </div>
                       </div>
                   </div>

                   <!-- CONFIGURACIONES ESPECIALES -->
                   <div class="special-controls" style="margin-top: 16px;">
                       <div class="form-group">
                           <label class="form-label"><i class="fas fa-dollar-sign"></i> Precio Personalizado</label>
                           <div class="price-editor">
                               <input type="number" class="form-input" id="precioPersonalizado" placeholder="Precio" min="0" step="1000" oninput="applyCustomPrice()">
                               <button class="btn-reset" onclick="resetPrice()" title="Restaurar precio original"><i class="fas fa-undo"></i></button>
                           </div>
                       </div>
                   </div>
               </div>

               <!-- TIPO DE EMBARCACI√ìN -->
               <div class="section">
                   <h2 class="section-title"><i class="fas fa-ship"></i> Tipo de Embarcaci√≥n</h2>
                   <div class="vessel-grid">
                       <div class="vessel-card" data-type="lancha" data-price="30000" onclick="selectVessel(this)">
                           <div class="vessel-icon"><i class="fas fa-ship"></i></div>
                           <div class="vessel-info">
                               <div class="vessel-name">Lancha Taxi</div>
                               <div class="vessel-price">$30,000</div>
                           </div>
                           <div class="vessel-selected"><i class="fas fa-check"></i></div>
                       </div>
                       <div class="vessel-card" data-type="deportiva" data-price="250000" onclick="selectVessel(this)">
                           <div class="vessel-icon"><i class="fas fa-rocket"></i></div>
                           <div class="vessel-info">
                               <div class="vessel-name">Deportiva</div>
                               <div class="vessel-price">$250,000</div>
                           </div>
                           <div class="vessel-selected"><i class="fas fa-check"></i></div>
                       </div>
                       <div class="vessel-card" data-type="planchon" data-price="350000" onclick="selectVessel(this)">
                           <div class="vessel-icon"><i class="fas fa-dharmachakra"></i></div>
                           <div class="vessel-info">
                               <div class="vessel-name">Planch√≥n</div>
                               <div class="vessel-price">$350,000</div>
                           </div>
                           <div class="vessel-selected"><i class="fas fa-check"></i></div>
                       </div>
                       <div class="vessel-card" data-type="carguero" data-price="200000" onclick="selectVessel(this)">
                           <div class="vessel-icon"><i class="fas fa-anchor"></i></div>
                           <div class="vessel-info">
                               <div class="vessel-name">Carguero</div>
                               <div class="vessel-price">$200,000</div>
                           </div>
                           <div class="vessel-selected"><i class="fas fa-check"></i></div>
                       </div>
                       <div class="vessel-card" data-type="barco" data-price="30000" onclick="selectVessel(this)">
                           <div class="vessel-icon"><i class="fas fa-ferry"></i></div>
                           <div class="vessel-info">
                               <div class="vessel-name">Barco</div>
                               <div class="vessel-price">$30,000</div>
                           </div>
                           <div class="vessel-selected"><i class="fas fa-check"></i></div>
                       </div>
                       <div class="vessel-card" data-type="yate" data-price="400000" onclick="selectVessel(this)">
                           <div class="vessel-icon"><i class="fas fa-sailboat"></i></div>
                           <div class="vessel-info">
                               <div class="vessel-name">Yate</div>
                               <div class="vessel-price">$400,000</div>
                           </div>
                           <div class="vessel-selected"><i class="fas fa-check"></i></div>
                       </div>
                   </div>
               </div>

               <!-- BOTONES DE ACCI√ìN -->
               <div class="action-buttons">
                   <button class="action-btn generate" id="generateBtn" onclick="generateTicketWithValidation()">
                       <i class="fas fa-ticket-alt"></i> Generar
                   </button>
                   <button class="action-btn print disabled" id="printBtn" onclick="showPrintModal()" disabled>
                       <i class="fas fa-print"></i> Imprimir
                   </button>
                   <button class="action-btn cancel disabled" id="cancelBtn" onclick="cancelTicket()" disabled>
                       <i class="fas fa-times-circle"></i> Anular
                   </button>
                   <button class="action-btn new" onclick="newTicket()">
                       <i class="fas fa-plus-circle"></i> Nuevo
                   </button>
               </div>
           </div>

           <!-- PANEL DE TICKET -->
           <div class="ticket-panel">
               <div class="ticket-header">
                   <h1 class="ticket-title"><i class="fas fa-anchor"></i>SISTEMA DE TRANSPORTE FLUVIAL</h1>
                   <p class="ticket-subtitle">Embalse de Guatap√©</p>
                   <div class="ticket-status" id="ticketStatus">BORRADOR</div>
               </div>

               <div class="ticket-info">
                   <div class="ticket-field">
                       <span class="field-label">Tipo de Servicio</span>
                       <span class="field-value" id="ticket-tipo-servicio">Nuevo Pasaje</span>
                   </div>
                   <div class="ticket-field">
                       <span class="field-label">Pasajero</span>
                       <span class="field-value" id="ticket-nombre">-</span>
                   </div>
                   <div class="ticket-field">
                       <span class="field-label">Documento</span>
                       <span class="field-value" id="ticket-documento">-</span>
                   </div>
                   <div class="ticket-field">
                       <span class="field-label">Fecha</span>
                       <span class="field-value" id="ticket-fecha">-</span>
                   </div>
                   <div class="ticket-field">
                       <span class="field-label">Hora</span>
                       <span class="field-value" id="ticket-hora">-</span>
                   </div>
                   <div class="ticket-field">
                       <span class="field-label">Embarcaci√≥n</span>
                       <span class="field-value" id="ticket-embarcacion">-</span>
                   </div>
                   <div class="ticket-field">
                       <span class="field-label">Pasajeros</span>
                       <span class="field-value" id="ticket-pasajeros">-</span>
                   </div>
               </div>

               <div class="ticket-total">
                   <div class="total-label">TOTAL A PAGAR</div>
                   <div class="total-amount" id="ticket-total">$0</div>
               </div>

               <div class="qr-section">
                   <div class="qr-placeholder" id="qr-container">
                       Genere el ticket para ver QR
                   </div>
                   <div class="ticket-code">C√≥digo: <span id="ticket-codigo">-</span></div>
               </div>

               <div class="timestamp" id="ticket-timestamp">
                   Vista previa - Ticket no generado
               </div>
           </div>
       </div>
       
       <!-- HEADER CON LOGOUT -->
       <div class="system-header">
           <div class="user-info">
               <span id="userEmail"></span>
               <button onclick="handleLogout()" class="logout-btn">
                   <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
               </button>
           </div>
       </div>
   </div>

   <!-- ===========================
        SCRIPTS EN ORDEN CORRECTO
        =========================== -->

   <!-- 1. Sistema de alertas (base) -->
   <script src="./js/alerts.js"></script>

   <!-- 2. Sistema de autenticaci√≥n PRIMERO -->
   <script src="./js/firebase-auth.js"></script>

   <!-- 3. Sistema de base de datos DESPU√âS de auth -->
   <script src="./js/firebase-database.js"></script>

   <!-- 4. Sistema de modales -->
   <script src="./js/modal.js"></script>

   <!-- 5. Generador de PDF -->
   <script src="./js/pdf-generator.js"></script>

   <!-- 6. Aplicaci√≥n principal -->
   <script src="./js/app.js"></script>

   <!-- 7. Sistema de impresi√≥n t√©rmica -->
   <script src="./js/thermal-printer.js"></script>

   <!-- Script de inicializaci√≥n mejorado -->
   <script>
       // ===========================
       // üîß INICIALIZACI√ìN MEJORADA
       // ===========================
       
       let originalPrintTicket = null;
       let systemReady = false;
       
       document.addEventListener('DOMContentLoaded', function() {
           console.log('üöÄ Iniciando sistema POS...');
           
           // Guardar funci√≥n original antes de conflictos
           if (typeof printTicket !== 'undefined') {
               originalPrintTicket = printTicket;
           }
           
           // Esperar a que todos los m√≥dulos se carguen
           setTimeout(() => {
               initializeCompleteSystem();
           }, 3000); // Aumentar tiempo de espera para Firebase
       });

       /**
        * Inicializaci√≥n completa del sistema con verificaciones mejoradas
        */
       async function initializeCompleteSystem() {
           console.log('üîß Inicializando sistema completo...');
           
           let dbReady = false;
           let authReady = false;
           let alertsReady = false;
           let modalsReady = false;
           
           // Verificar Firebase Database con reintentos
           console.log('üîç Verificando Firebase Database...');
           for (let i = 0; i < 50; i++) { // 50 intentos = 5 segundos
               if (typeof window.firebaseDatabase !== 'undefined') {
                   console.log(`üîÑ Firebase Database encontrado, verificando inicializaci√≥n... (intento ${i + 1})`);
                   if (window.firebaseDatabase.isInitialized) {
                       dbReady = true;
                       console.log('‚úÖ Firebase Database listo');
                       break;
                   }
               }
               await new Promise(resolve => setTimeout(resolve, 100));
           }
           
           // Verificar Auth Manager
           console.log('üîç Verificando Auth Manager...');
           for (let i = 0; i < 30; i++) {
               if (typeof window.authManager !== 'undefined' && window.authManager.isInitialized) {
                   authReady = true;
                   console.log('‚úÖ Auth Manager listo');
                   break;
               }
               await new Promise(resolve => setTimeout(resolve, 100));
           }
           
           // Verificar otros componentes
           alertsReady = typeof window.alertSystem !== 'undefined';
           modalsReady = typeof window.modalSystem !== 'undefined';
           
           console.log('üîç Estado final de componentes:');
           console.log('  - Auth Manager:', authReady ? '‚úÖ' : '‚ùå');
           console.log('  - Firebase DB:', dbReady ? '‚úÖ' : '‚ùå');
           console.log('  - Alert System:', alertsReady ? '‚úÖ' : '‚ùå');
           console.log('  - Modal System:', modalsReady ? '‚úÖ' : '‚ùå');
           
           // Verificar estado detallado de Firebase
           if (typeof window.firebaseDatabase !== 'undefined') {
               const dbStatus = window.firebaseDatabase.getConnectionStatus();
               console.log('üìä Estado detallado Firebase:');
               console.log('  - Inicializado:', dbStatus.isInitialized);
               console.log('  - Conectado:', dbStatus.isConnected);
               console.log('  - Reintentos:', dbStatus.retryAttempts + '/' + dbStatus.maxRetries);
               
               // Si no est√° conectado, intentar reconectar
               if (dbStatus.isInitialized && !dbStatus.isConnected) {
                   console.log('üîÑ Intentando reconectar Firebase...');
                   try {
                       await window.firebaseDatabase.reconnect();
                       console.log('‚úÖ Reconexi√≥n exitosa');
                   } catch (error) {
                       console.error('‚ùå Error en reconexi√≥n:', error);
                   }
               }
           }
           
           if (!authReady) {
               console.error('‚ùå Auth Manager no disponible - Sistema no funcional');
               if (alertsReady) {
                   window.alertSystem.error('Error cr√≠tico', 'Sistema de autenticaci√≥n no disponible');
               }
               return;
           }
           
           if (!dbReady) {
               console.warn('‚ö†Ô∏è Firebase Database no disponible - Funcionalidad limitada');
               if (alertsReady) {
                   window.alertSystem.warning('Advertencia', 'Base de datos no disponible - Funcionalidad limitada');
               }
           }
           
           // Configurar funci√≥n de impresi√≥n
           setupPrintFunction();
           
           systemReady = true;
           console.log('‚úÖ Sistema POS inicializado completamente');
           
           if (alertsReady) {
               if (dbReady && authReady) {
                   window.alertSystem.success('Sistema listo', 'POS inicializado con todas las funcionalidades');
               } else {
                   window.alertSystem.info('Sistema parcial', 'POS inicializado con funcionalidad limitada');
               }
           }
       }

       /**
        * Configurar funci√≥n de impresi√≥n unificada
        */
       function setupPrintFunction() {
           window.printTicket = showPrintModal;
           window.showPrintModal = showPrintModal;
           console.log('üîß Funci√≥n de impresi√≥n unificada configurada');
       }

       /**
        * Funci√≥n principal de impresi√≥n
        */
       function showPrintModal() {
           if (!ticketGenerated || ticketCancelled) {
               if (typeof showError !== 'undefined') {
                   showError('Error de impresi√≥n', 'Debe generar un ticket v√°lido antes de imprimir');
               }
               return;
           }

           console.log('üñ®Ô∏è Iniciando proceso de impresi√≥n...');

           if (typeof modalSystem !== 'undefined' && modalSystem.isInitialized) {
               console.log('üé≠ Usando sistema de modales');
               modalSystem.showPrintOptionsModal();
           } else if (typeof thermalPrinter !== 'undefined') {
               console.log('üñ®Ô∏è Usando thermal printer como fallback');
               const useDirectPrint = confirm(
                   'Seleccione m√©todo de impresi√≥n:\n\n' +
                   'OK = Impresora T√©rmica/Directa\n' +
                   'Cancelar = Generar PDF'
               );
               
               if (useDirectPrint) {
                   thermalPrinter.printThermalTicket();
               } else if (typeof generateTicketPDF !== 'undefined') {
                   generateTicketPDF('thermal');
               } else {
                   alert('Generador de PDF no disponible');
               }
           } else if (originalPrintTicket) {
               console.log('üìÑ Usando funci√≥n original de app.js');
               originalPrintTicket();
           } else {
               console.error('‚ùå No hay sistemas de impresi√≥n disponibles');
               if (typeof showError !== 'undefined') {
                   showError('Error', 'No hay sistemas de impresi√≥n disponibles');
               }
           }
       }

       // ===========================
       // üîó FUNCIONES DE INTEGRACI√ìN
       // ===========================

       /**
        * Funci√≥n auxiliar para impresi√≥n directa desde modal
        */
       window.directPrintFromModal = function() {
           if (typeof thermalPrinter !== 'undefined') {
               thermalPrinter.printThermalTicket();
           } else if (originalPrintTicket) {
               originalPrintTicket();
           } else if (typeof directPrint !== 'undefined') {
               directPrint();
           } else {
               console.error('‚ùå No hay m√©todos de impresi√≥n directa disponibles');
           }
       };

       /**
        * Funci√≥n auxiliar para PDF desde modal
        */
       window.generatePDFFromModal = function(format = 'thermal') {
           if (typeof generateTicketPDF !== 'undefined') {
               return generateTicketPDF(format);
           } else if (typeof pdfGenerator !== 'undefined') {
               return pdfGenerator.generateTicketPDF(format);
           } else {
               console.error('‚ùå Generador de PDF no disponible');
               return false;
           }
       };

       /**
        * Funci√≥n de diagn√≥stico del sistema
        */
       window.diagnosticSystem = function() {
           console.log('üîç DIAGN√ìSTICO DEL SISTEMA POS');
           console.log('================================');
           
           const components = [
               { name: 'Auth Manager', obj: window.authManager, ready: window.authManager?.isInitialized },
               { name: 'Firebase DB', obj: window.firebaseDatabase, ready: window.firebaseDatabase?.isInitialized },
               { name: 'Alert System', obj: window.alertSystem, ready: !!window.alertSystem },
               { name: 'Modal System', obj: window.modalSystem, ready: window.modalSystem?.isInitialized },
               { name: 'PDF Generator', obj: window.pdfGenerator, ready: window.pdfGenerator?.isInitialized },
               { name: 'Thermal Printer', obj: window.thermalPrinter, ready: window.thermalPrinter?.isInitialized }
           ];
           
           components.forEach(comp => {
               const status = comp.obj ? (comp.ready ? '‚úÖ LISTO' : '‚ö†Ô∏è CARGADO') : '‚ùå NO DISPONIBLE';
               console.log(`  - ${comp.name}: ${status}`);
           });
           
           if (window.firebaseDatabase) {
               const dbStatus = window.firebaseDatabase.getConnectionStatus();
               console.log('üìä Estado Firebase:');
               console.log(`  - Inicializado: ${dbStatus.isInitialized ? '‚úÖ' : '‚ùå'}`);
               console.log(`  - Conectado: ${dbStatus.isConnected ? '‚úÖ' : '‚ùå'}`);
               console.log(`  - Reintentos: ${dbStatus.retryAttempts}/${dbStatus.maxRetries}`);
           }
           
           console.log('================================');
           return components;
       };

       /**
        * Funci√≥n para probar Firebase manualmente
        */
       window.testFirebase = async function() {
           if (typeof window.firebaseDatabase === 'undefined') {
               console.error('‚ùå Firebase Database no disponible');
               return false;
           }
           
           console.log('üß™ Probando Firebase Database...');
           return await window.firebaseDatabase.testConnection();
       };

       /**
        * Funci√≥n para reconectar Firebase manualmente
        */
       window.reconnectFirebase = async function() {
           if (typeof window.firebaseDatabase === 'undefined') {
               console.error('‚ùå Firebase Database no disponible');
               return false;
           }
           
           console.log('üîÑ Reconectando Firebase...');
           try {
               await window.firebaseDatabase.reconnect();
               console.log('‚úÖ Reconexi√≥n exitosa');
               return true;
           } catch (error) {
               console.error('‚ùå Error en reconexi√≥n:', error);
               return false;
           }
       };
   </script>

</body>
</html>
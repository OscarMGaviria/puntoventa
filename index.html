<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema POS - Embarcaciones Guatap√©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="main.css">
    
</head>
<body>
    <!-- SISTEMA PRINCIPAL -->
    <div class="main-container">
        <!-- PANEL POS -->
        <div class="pos-panel">
            <!-- INFORMACI√ìN DEL PASAJERO -->
            <div class="section">
                <h2 class="section-title"><i class="fas fa-user"></i> Informaci√≥n del Pasajero</h2>
                <div class="passenger-info-grid">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" class="form-input" id="nombre" placeholder="Juan P√©rez Garc√≠a">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Documento</label>
                        <input type="text" class="form-input" id="documento" placeholder="12345678">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="emailCliente" placeholder="ejemplo@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tel√©fono</label>
                        <input type="tel" class="form-input" id="telefono" placeholder="+57 300 123 4567">
                    </div>
                </div>
            </div>

            <!-- DETALLES DEL VIAJE -->
            <div class="section">
                <h2 class="section-title"><i class="fas fa-calendar-alt"></i> Detalles del Viaje</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Fecha de Viaje</label>
                        <input type="date" class="form-input" id="fecha">
                    </div>
                    <div class="form-group1">
                        <label class="form-label"><i class="fas fa-users"></i> Adultos</label>
                        <div class="counter-group">
                            <button class="counter-btn" onclick="decrementCounter('adultos')"><i class="fas fa-minus"></i></button>
                            <input type="number" class="counter-input" id="adultos" value="1" min="1" max="100">
                            <button class="counter-btn" onclick="incrementCounter('adultos')"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="form-group1">
                        <label class="form-label">Ni√±os (0-5 a√±os)</label>
                        <div class="counter-group">
                            <button class="counter-btn" onclick="decrementCounter('ninos')"><i class="fas fa-minus"></i></button>
                            <input type="number" class="counter-input" id="ninos" value="0" min="0" max="10">
                            <button class="counter-btn" onclick="incrementCounter('ninos')"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>

                <!-- CONFIGURACIONES ESPECIALES -->
                <div class="special-controls" style="margin-top: 16px;">

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-dollar-sign"></i> Precio Personalizado</label>
                        <div class="price-editor">
                            <input type="number" class="form-input" id="precioPersonalizado" placeholder="Precio" min="0" step="1000" oninput="applyCustomPrice()">
                            <button class="btn-reset" onclick="resetPrice()" title="Restaurar precio original"><i class="fas fa-undo"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TIPO DE EMBARCACI√ìN -->
            <div class="section">
                <h2 class="section-title"><i class="fas fa-ship"></i> Tipo de Embarcaci√≥n</h2>
                <div class="vessel-grid">
                    <div class="vessel-card" data-type="lancha" data-price="30000" onclick="selectVessel(this)">
                        <div class="vessel-icon"><i class="fas fa-ship"></i></div>
                        <div class="vessel-info">
                            <div class="vessel-name">Lancha Taxi</div>
                            <div class="vessel-price">$30,000</div>
                        </div>
                        <div class="vessel-selected"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="vessel-card" data-type="deportiva" data-price="250000" onclick="selectVessel(this)">
                        <div class="vessel-icon"><i class="fas fa-rocket"></i></div>
                        <div class="vessel-info">
                            <div class="vessel-name">Deportiva</div>
                            <div class="vessel-price">$250,000</div>
                        </div>
                        <div class="vessel-selected"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="vessel-card" data-type="planchon" data-price="350000" onclick="selectVessel(this)">
                        <div class="vessel-icon"><i class="fas fa-dharmachakra"></i></div>
                        <div class="vessel-info">
                            <div class="vessel-name">Planch√≥n</div>
                            <div class="vessel-price">$350,000</div>
                        </div>
                        <div class="vessel-selected"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="vessel-card" data-type="carguero" data-price="200000" onclick="selectVessel(this)">
                        <div class="vessel-icon"><i class="fas fa-anchor"></i></div>
                        <div class="vessel-info">
                            <div class="vessel-name">Carguero</div>
                            <div class="vessel-price">$200,000</div>
                        </div>
                        <div class="vessel-selected"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="vessel-card" data-type="barco" data-price="30000" onclick="selectVessel(this)">
                        <div class="vessel-icon"><i class="fas fa-ferry"></i></div>
                        <div class="vessel-info">
                            <div class="vessel-name">Barco</div>
                            <div class="vessel-price">$30,000</div>
                        </div>
                        <div class="vessel-selected"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="vessel-card" data-type="yate" data-price="400000" onclick="selectVessel(this)">
                        <div class="vessel-icon"><i class="fas fa-sailboat"></i></div>
                        <div class="vessel-info">
                            <div class="vessel-name">Yate</div>
                            <div class="vessel-price">$400,000</div>
                        </div>
                        <div class="vessel-selected"><i class="fas fa-check"></i></div>
                    </div>
                </div>
            </div>

            <!-- BOTONES DE ACCI√ìN -->
            <div class="action-buttons">
                <button class="action-btn generate" id="generateBtn" onclick="generateTicketWithValidation()">
                    <i class="fas fa-ticket-alt"></i> Generar
                </button>
                <!-- BOT√ìN DE IMPRESI√ìN CORREGIDO PARA EVITAR CONFLICTO -->
                <button class="action-btn print disabled" id="printBtn" onclick="showPrintModal()" disabled>
                    <i class="fas fa-print"></i> Imprimir 
                </button>
                <button class="action-btn cancel disabled" id="cancelBtn" onclick="cancelTicket()" disabled>
                    <i class="fas fa-times-circle"></i> Anular
                </button>
                <button class="action-btn new" onclick="newTicket()">
                    <i class="fas fa-plus-circle"></i> Nuevo
                </button>
            </div>
        </div>

        <!-- PANEL DE TICKET -->
        <div class="ticket-panel">
            <div class="ticket-header">
                <h1 class="ticket-title"><i class="fas fa-anchor"></i>SISTEMA DE TRANSPORTE FLUVIAL</h1>
                <p class="ticket-subtitle">Embalse de Guatap√©</p>
                <div class="ticket-status" id="ticketStatus">BORRADOR</div>
            </div>

            <div class="ticket-info">
                <div class="ticket-field">
                    <span class="field-label">Tipo de Servicio</span>
                    <span class="field-value" id="ticket-tipo-servicio">Nuevo Pasaje</span>
                </div>
                <div class="ticket-field">
                    <span class="field-label">Pasajero</span>
                    <span class="field-value" id="ticket-nombre">-</span>
                </div>
                <div class="ticket-field">
                    <span class="field-label">Documento</span>
                    <span class="field-value" id="ticket-documento">-</span>
                </div>
                <div class="ticket-field">
                    <span class="field-label">Fecha</span>
                    <span class="field-value" id="ticket-fecha">-</span>
                </div>
                <div class="ticket-field">
                    <span class="field-label">Hora</span>
                    <span class="field-value" id="ticket-hora">-</span>
                </div>
                <div class="ticket-field">
                    <span class="field-label">Embarcaci√≥n</span>
                    <span class="field-value" id="ticket-embarcacion">-</span>
                </div>
                <div class="ticket-field">
                    <span class="field-label">Pasajeros</span>
                    <span class="field-value" id="ticket-pasajeros">-</span>
                </div>
            </div>

            <div class="ticket-total">
                <div class="total-label">TOTAL A PAGAR</div>
                <div class="total-amount" id="ticket-total">$0</div>
            </div>

            <div class="qr-section">
                <div class="qr-placeholder" id="qr-container">
                    Genere el ticket para ver QR
                </div>
                <div class="ticket-code">C√≥digo: <span id="ticket-codigo">-</span></div>
            </div>

            <div class="timestamp" id="ticket-timestamp">
                Vista previa - Ticket no generado
            </div>
        </div>
    </div>

    <!-- ===========================
         SCRIPTS EN ORDEN CORRECTO
         SOLUCI√ìN AL CONFLICTO thermal-printer.js
         =========================== -->
    
    <!-- 1. Sistema de alertas (base) -->
    <script src="./js/alerts.js"></script>
    
    <!-- 2. Sistema de modales (depende de alertas) -->
    <script src="./js/modal.js"></script>
    
    <!-- 3. Generador de PDF (depende de alertas) -->
    <script src="./js/pdf-generator.js"></script>
    
    <!-- 4. Aplicaci√≥n principal ANTES de thermal-printer -->
    <script src="./js/app.js"></script>
    
    <!-- 5. Sistema de impresi√≥n t√©rmica (DESPU√âS para evitar sobrescribir) -->
    <script src="./js/thermal-printer.js"></script>
    
    <!-- 6. Sistema de autenticaci√≥n (opcional) -->
    <script src="./js/firebase-auth.js"></script>

    <!-- Script de resoluci√≥n de conflictos y funci√≥n principal de impresi√≥n -->
    <script>
        // ===========================
        // üîß RESOLUCI√ìN DE CONFLICTOS
        // ===========================
        
        // Guardar referencia a la funci√≥n original de app.js antes de que thermal-printer la sobrescriba
        let originalPrintTicket = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Guardar la funci√≥n printTicket de app.js
            if (typeof printTicket !== 'undefined') {
                originalPrintTicket = printTicket;
            }
            
            // Esperar a que thermal-printer.js se cargue completamente
            setTimeout(() => {
                setupPrintFunction();
                verifySystem();
            }, 1500);
        });

        /**
         * üñ®Ô∏è FUNCI√ìN PRINCIPAL DE IMPRESI√ìN (RESUELVE CONFLICTO)
         * Esta funci√≥n maneja ambos sistemas: modal y thermal-printer
         */
        function showPrintModal() {
            // Verificar si el ticket est√° generado y es v√°lido
            if (!ticketGenerated || ticketCancelled) {
                if (typeof showError !== 'undefined') {
                    showError('Error de impresi√≥n', 'Debe generar un ticket v√°lido antes de imprimir');
                }
                return;
            }

            console.log('üñ®Ô∏è Iniciando proceso de impresi√≥n...');

            // Priorizar el modal si est√° disponible
            if (typeof modalSystem !== 'undefined' && modalSystem.isInitialized) {
                console.log('üé≠ Usando sistema de modales');
                modalSystem.showPrintOptionsModal();
            } 
            // Fallback a thermal-printer si no hay modal
            else if (typeof thermalPrinter !== 'undefined') {
                console.log('üñ®Ô∏è Usando thermal-printer como fallback');
                // Preguntar al usuario con confirm nativo
                const useDirectPrint = confirm(
                    'Seleccione m√©todo de impresi√≥n:\n\n' +
                    'OK = Impresora T√©rmica/Directa\n' +
                    'Cancelar = Generar PDF'
                );
                
                if (useDirectPrint) {
                    thermalPrinter.printThermalTicket();
                } else {
                    // Generar PDF
                    if (typeof generateTicketPDF !== 'undefined') {
                        generateTicketPDF('thermal');
                    } else {
                        alert('Generador de PDF no disponible');
                    }
                }
            }
            // √öltimo recurso: funci√≥n original de app.js
            else if (originalPrintTicket) {
                console.log('üìÑ Usando funci√≥n original de app.js');
                originalPrintTicket();
            }
            else {
                console.error('‚ùå No hay sistemas de impresi√≥n disponibles');
                if (typeof showError !== 'undefined') {
                    showError('Error', 'No hay sistemas de impresi√≥n disponibles');
                }
            }
        }

        /**
         * Configurar la funci√≥n de impresi√≥n correcta
         */
        function setupPrintFunction() {
            // Sobrescribir cualquier funci√≥n printTicket global con nuestra funci√≥n unificada
            window.printTicket = showPrintModal;
            
            console.log('üîß Funci√≥n de impresi√≥n unificada configurada');
        }

        /**
         * Verificar que todos los sistemas est√©n funcionando
         */
        function verifySystem() {
            console.log('=================================');
            console.log('üîç VERIFICACI√ìN DEL SISTEMA POS');
            console.log('=================================');
            
            // Verificar sistemas principales
            console.log('üì¢ Sistema de alertas:', typeof alertSystem !== 'undefined' ? '‚úÖ OK' : '‚ùå ERROR');
            console.log('üé≠ Sistema de modales:', typeof modalSystem !== 'undefined' ? '‚úÖ OK' : '‚ùå ERROR');
            console.log('üìÑ Generador de PDF:', typeof pdfGenerator !== 'undefined' ? '‚úÖ OK' : '‚ùå ERROR');
            console.log('üñ®Ô∏è Thermal Printer:', typeof thermalPrinter !== 'undefined' ? '‚úÖ OK' : '‚ùå ERROR');
            console.log('üîß Funci√≥n printTicket:', typeof printTicket !== 'undefined' ? '‚úÖ OK' : '‚ùå ERROR');
            
            // Verificar integraci√≥n modal
            if (typeof modalSystem !== 'undefined' && modalSystem.isInitialized) {
                console.log('üîó Modal de impresi√≥n:', typeof modalSystem.showPrintOptionsModal === 'function' ? '‚úÖ OK' : '‚ùå ERROR');
            }
            
            // Estado final
            console.log('=================================');
            if (typeof modalSystem !== 'undefined' && typeof thermalPrinter !== 'undefined') {
                console.log('üéØ SISTEMA H√çBRIDO ACTIVO');
                console.log('   Modal + Thermal Printer disponibles');
            } else if (typeof modalSystem !== 'undefined') {
                console.log('üé≠ SISTEMA MODAL ACTIVO');
                console.log('   Solo modales disponibles');
            } else if (typeof thermalPrinter !== 'undefined') {
                console.log('üñ®Ô∏è SISTEMA THERMAL ACTIVO');
                console.log('   Solo thermal printer disponible');
            }
            console.log('‚úÖ Sistema POS verificado y funcionando');
            console.log('=================================');
        }

        // ===========================
        // üîó FUNCIONES DE INTEGRACI√ìN
        // ===========================

        /**
         * Funci√≥n auxiliar para thermal-printer
         */
        window.directPrintFromThermal = function() {
            if (typeof thermalPrinter !== 'undefined') {
                thermalPrinter.printThermalTicket();
            }
        };

        /**
         * Funci√≥n auxiliar para PDF desde modal
         */
        window.generatePDFFromModal = function(format = 'thermal') {
            if (typeof generateTicketPDF !== 'undefined') {
                return generateTicketPDF(format);
            } else if (typeof pdfGenerator !== 'undefined') {
                return pdfGenerator.generateTicketPDF(format);
            } else {
                console.error('‚ùå Generador de PDF no disponible');
                return false;
            }
        };

        /**
         * Funci√≥n auxiliar para impresi√≥n directa desde modal
         */
        window.directPrintFromModal = function() {
            // Priorizar thermal printer si est√° disponible
            if (typeof thermalPrinter !== 'undefined') {
                thermalPrinter.printThermalTicket();
            } 
            // Fallback a funci√≥n original
            else if (originalPrintTicket) {
                originalPrintTicket();
            }
            // √öltimo recurso: funci√≥n de app.js
            else if (typeof directPrint !== 'undefined') {
                directPrint();
            }
            else {
                console.error('‚ùå No hay m√©todos de impresi√≥n directa disponibles');
            }
        };
    </script>

</body>

</html>
